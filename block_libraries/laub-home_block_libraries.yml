uid: Blocklibraries_laub-home.de
tags:
  - heating
  - thermostat
  - control
  - Thing
  - laub-home
props:
  parameters: []
  parameterGroups: []
timestamp: Oct 30, 2025, 8:30:19 AM
component: BlockLibrary
config:
  name: Blocklibraries laub-home.de
slots:
  blocks:
    - component: BlockType
      config:
        type: Thermostat Control
        inputsInline: false
        message0: Control thermostat (thermostat switch item) %1
          with setpoint temperature (setpoint item) %2,
          heating valve (switch item) %3,
          temperature sensor (temperature item) %4,
          hysteresis (in °C) (Number) %5,
          absence reduction (in °C) (Number) %6,
          green increase (in °C) %7,
          night start (time) %8,
          night stop (time) %9,
          night reduction (in °C) (Number) %10,
          (optional) Absence (switch item - default "ON") %11,
          (optional) Booster (switch item - default "OFF") %12,
          (optional) Smart-Grid Mode (red-orange-green item - default "orange") %13,
          (optional) Setpoint Effective Temperature (temperature item) %14,
          (optional) Window contact (Contact item - default "CLOSED") %15,
          (optional) Window delay (in minutes) %16,
          and set loglevel %17
        nextStatement: ""
        previousStatement: ""  
        args0:
          - name: THERMOSTAT
            type: input_value
          - name: SETPOINTTEMPERATURE
            type: input_value
          - name: HEATINGVALVE
            type: input_value
          - name: TEMPERATURESENSOR
            type: input_value
          - name: HYSTERESIS
            type: input_value
          - name: ABSENCEREDUCTION
            type: input_value
          - name: GREENINCREASE
            type: input_value
          - name: NIGHTSTART
            type: input_value
          - name: NIGHTSTOP
            type: input_value
          - name: NIGHTREDUCTION
            type: input_value
          - name: ABSENCE
            type: input_value
          - name: BOOSTER
            type: input_value
          - name: SMARTGRID
            type: input_value
          - name: SETPOINTEFFECTIVE
            type: input_value
          - name: WINDOWCONTACT
            type: input_value
          - name: WINDOW_DELAY_MIN
            type: input_value
          - name: LOGLEVEL
            options:
              - - info
                - info
              - - warn
                - warn
              - - error
                - error
              - - debug
                - debug
            type: field_dropdown
        colour: 90
        tooltip: Control a thermostat with dynamic parameters and OpenHAB items.
        helpUrl: ""
      slots:
        code:
          - component: BlockCodeTemplate
            config:
              template: >
                var { time, items } = require('openhab');
                var ruleUID = this.ruleUID;
                var logger = Java.type('org.slf4j.LoggerFactory').getLogger(`org.openhab.rule.ThermoCtrl.${ruleUID}`);
                /* Window-Blocker Map im globalen Kontext (pro Heizzone über Ventil-Key) */
                var __THERMO_WINDOW_BLOCKS = globalThis.__THERMO_WINDOW_BLOCKS || (globalThis.__THERMO_WINDOW_BLOCKS = new Map());
                var __THERMO_WINDOW_WASOPEN = globalThis.__THERMO_WINDOW_WASOPEN || (globalThis.__THERMO_WINDOW_WASOPEN = new Map());

                /* Optionales Post-Update auf ein Item (ignoriert leere/ungültige Namen) */
                function safePostUpdate(itemName, value) {
                  try {
                    const n = String(itemName ?? '').trim();
                    if (!n) return;
                    items.getItem(n).postUpdate(String(value));
                  } catch (e) {
                    // Item existiert nicht oder falscher Typ -> still ignorieren
                  }
                }

                /* Flex: liest State aus Itemname ODER benutzt Literal ODER Default, wenn leer/UNDEF */
                function readFlexibleState(v, defaultValue) {
                  if (v === null || v === undefined) return defaultValue;
                  const s = String(v).trim();
                  if (!s) return defaultValue;
                  try {
                    const it = items.getItem(s);               // Falls s ein Itemname ist
                    const st = String(it.state);
                    if (st === 'NULL' || st === 'UNDEF' || st === '') return defaultValue;
                    return st;
                  } catch (e) {
                    // s ist kein Itemname → als Literal verwenden
                    return s;
                  }
                }

                /* Normalisiert Switch-ähnliche Werte auf 'ON'/'OFF' (toleriert true/false, 1/0, yes/no, OPEN/CLOSED) */
                function normalizeSwitch(val, defaultValue) {
                  const t = String(val ?? '').trim().toUpperCase();
                  if (t === 'ON' || t === 'TRUE' || t === '1' || t === 'YES' || t === 'OPEN') return 'ON';
                  if (t === 'OFF' || t === 'FALSE' || t === '0' || t === 'NO' || t === 'CLOSED') return 'OFF';
                  return defaultValue ?? 'OFF';
                }

                /* Normalisiert Ampel-Text auf 'red'|'orange'|'green' (toleriert Abkürzungen & dt. Begriffe) */
                function normalizeTraffic(val, defaultValue) {
                  const t = String(val ?? '').trim().toLowerCase();
                  if (t === 'red' || t === 'r' || t === 'rot') return 'red';
                  if (t === 'orange' || t === 'o' || t === 'amber' || t === 'gelb') return 'orange';
                  if (t === 'green' || t === 'g' || t === 'gruen' || t === 'grün') return 'green';
                  return defaultValue ?? 'orange';
                }

                function isWindowOpen(name) {
                  if (!name) return false;
                  try {
                    const st = String(items.getItem(String(name).trim()).state);
                    return st === 'OPEN';
                  } catch (e) {
                    return false; // Name leer/kein Item -> ignorieren
                  }
                }

                /* Logik für „Fenster offen“ + Cooldown nach Schließen
                  - key: eindeutiger Schlüssel der Zone (wir nehmen das Heinzungsventil-Item)
                  - isOpen: aktueller Fensterzustand
                  - delayMin: gewünschte Blockdauer in Minuten
                  Rückgabe: { blocked: true/false, reason: 'open'|'cooldown', until: ZDT|null }
                */
                function enforceWindowDelay(key, isOpen, delayMin, time, logger) {
                  const now = time.ZonedDateTime.now();
                  const wasOpen = __THERMO_WINDOW_WASOPEN.get(key) === true;
                  __THERMO_WINDOW_WASOPEN.set(key, isOpen);

                  const existingUntil = __THERMO_WINDOW_BLOCKS.get(key); // hier speichern wir NUR den Cooldown-bis-Zeitpunkt

                  if (isOpen) {
                    // Solange offen: blockieren, Ventil OFF, aber KEIN Cooldown-Zeitpunkt setzen
                    return { blocked: true, reason: 'open', until: null };
                  }

                  // Jetzt geschlossen:
                  if (wasOpen && !isOpen) {
                    // Übergang OPEN -> CLOSED: Cooldown ab JETZT starten
                    const newUntil = now.plusMinutes(Number(delayMin) || 5);
                    __THERMO_WINDOW_BLOCKS.set(key, newUntil);
                    return { blocked: true, reason: 'cooldown', until: newUntil };
                  }

                  // Bereits laufender Cooldown nach früherem Schließen?
                  if (existingUntil && now.isBefore(existingUntil)) {
                    return { blocked: true, reason: 'cooldown', until: existingUntil };
                  }

                  // Cooldown abgelaufen -> aufräumen
                  if (existingUntil && !now.isBefore(existingUntil)) {
                    __THERMO_WINDOW_BLOCKS.delete(key);
                  }

                  return { blocked: false, reason: null, until: null };
                }

                function toLocalTimeFlexible(v) {
                  if (v === null || v === undefined) return null;
                  const s = String(v).trim();
                  if (!s) return null;

                  try {
                    const it = items.getItem(s); // wirft, falls es das Item nicht gibt
                    const st = String(it.state);
                    if (st === 'NULL' || st === 'UNDEF') return null;
                    return time.toZDT(it.state).toLocalTime();
                  } catch (e) {
                    try {
                      return time.toZDT(s).toLocalTime();
                    } catch (parseErr) {
                      logger.warn(`ThermoCtrl: Konnte Zeit nicht parsen: "${s}"`);
                      return null;
                    }
                  }
                }

                function controlThermostat(config) {
                  const {
                    setpointTemperature,
                    heatingvalve,
                    hysteresis,
                    temperaturesensor,
                    thermostat,
                    absencereduction,
                    greenincrease,
                    nightstart,
                    nightstop,
                    nightreduction,
                    loglevel,
                    absence,
                    booster,
                    smartgrid,                    
                    windowcontact,
                    windowDelayMin,
                    setpointEffective
                  } = config;

                  // Initialize logging
                  const log = logger[loglevel] || logger.error;
                  log(`Thermostat - Loglevel set to: ${loglevel}`);
                  
                  const currentTemperature = Quantity(items.getItem(temperaturesensor).state);
                  const thermostatTemperature = Quantity(items.getItem(setpointTemperature).state);
                  // Flexible Eingaben verarbeiten (Itemname, Literal oder leer -> Default)
                  const absenceState  = normalizeSwitch(  readFlexibleState(absence,  'ON'),  'ON');
                  const boosterState  = normalizeSwitch(  readFlexibleState(booster,  'OFF'), 'OFF');
                  const sgState       = normalizeTraffic( readFlexibleState(smartgrid,'orange'),'orange');

                  log('Inputs normalized — absence=' + absenceState + ', booster=' + boosterState + ', smartgrid=' + sgState);
                  log(`Thermostat - running: ${items.getItem(thermostat).label} - Valve power: ${items.getItem(heatingvalve).state}`);
                  log(`Current temperature: ${currentTemperature} - Thermostat setpoint temperature: ${thermostatTemperature}`);
                  log(`Heating ON temperature value: ${thermostatTemperature.subtract(Quantity(hysteresis + '°C'))} - Heating OFF temperature value: ${thermostatTemperature}`);

                  let setpoint = thermostatTemperature;

                  if (boosterState  === 'OFF') {
                    log('Booster Switch is OFF');
                    if (items.getItem(thermostat).state === 'ON') {
                      log('Thermostat Switch is ON');

                      // Absence and SG-red check
                      if (absenceState === 'OFF' && sgState === 'red') {
                        setpoint = thermostatTemperature.subtract(Quantity(absencereduction + '°C'));
                        log(`Absence and SG-RED Mode - used setpoint temperature: ${setpoint}`);
                      } else {
                        // SG-Modus green
                        if (sgState === 'green') {
                          setpoint = thermostatTemperature.add(Quantity(greenincrease + '°C'));
                          log(`Heat pump SG-Green mode - used setpoint temperature: ${setpoint}`);
                        }

                        // Night setback (nur Uhrzeit/LocalTime; Datum wird ignoriert)
                        const nowLT = time.ZonedDateTime.now().toLocalTime();

                        const nightStartLT = toLocalTimeFlexible(nightstart);
                        const nightStopLT  = toLocalTimeFlexible(nightstop);

                        log(`Current Time (LocalTime): ${nowLT}`);
                        log(`night start (LocalTime):  ${nightStartLT}`);
                        log(`night stop  (LocalTime):  ${nightStopLT}`);

                        let nightActive = false;
                        if (nightStartLT && nightStopLT) {
                          if (nightStopLT.isAfter(nightStartLT)) {
                            nightActive = nowLT.isAfter(nightStartLT) && nowLT.isBefore(nightStopLT);
                          } else {
                            nightActive = nowLT.isAfter(nightStartLT) || nowLT.isBefore(nightStopLT);
                          }
                        } else {
                          log('Night setback times missing (NULL/UNDEF/parse error) – night setback disabled.');
                        }

                        if (nightActive) {
                          setpoint = thermostatTemperature.subtract(Quantity(nightreduction + '°C'));
                          log(`Night setback active - used setpoint temperature: ${setpoint}`);
                        } else {
                          log(`Night setback deactivated - used setpoint temperature: ${setpoint}`);
                        }
                      }  

                      // Effektiven Sollwert ins (optionale) Item schreiben
                      safePostUpdate(setpointEffective, setpoint);

                      /* Fensterzustand + Delay/Cooldown prüfen (Ventil-Item dient als Zonenschlüssel) */
                      const valveKey = String(heatingvalve); // identifiziert die Zone
                      const openNow = isWindowOpen(windowcontact);
                      const delayMin = Number(windowDelayMin) || 5;
                      const block = enforceWindowDelay(valveKey, openNow, delayMin, time, logger);

                      if (block.blocked) {
                        if (String(items.getItem(heatingvalve).state) !== 'OFF') {
                          items.getItem(heatingvalve).sendCommand('OFF');
                        }
                        const why = (block.reason === 'open') ? 'window OPEN' : ('cooldown ' + delayMin + ' min after close');
                        const untilStr = block.until ? String(block.until) : '';
                        log('Window block active (' + why + ') until ' + untilStr + ' — heating valve forced OFF.');
                        return; // Rest der Regel überspringen
                      }

                      // Heating control
                      if (
                        items.getItem(heatingvalve).state === 'OFF' &&
                        currentTemperature.lessThanOrEqual(setpoint.subtract(Quantity(hysteresis + '°C')))
                      ) {
                        items.getItem(heatingvalve).sendCommand('ON');
                        log('Heating control - heating activated');
                      } else if (
                        items.getItem(heatingvalve).state === 'ON' &&
                        currentTemperature.greaterThanOrEqual(setpoint)
                      ) {
                        items.getItem(heatingvalve).sendCommand('OFF');
                        log('Heating control - heating deactivated');
                      }
                    } else {
                      log('Thermostat Switch is OFF');
                      // Effektiven Sollwert ins (optionale) Item schreiben
                      safePostUpdate(setpointEffective, setpoint);                   
                      if (items.getItem(heatingvalve).state === 'ON') {
                        items.getItem(heatingvalve).sendCommand('OFF');
                        log('Heating control - heating deactivated');
                      }
                    }
                  } else {
                    log('Thermostat - Booster Mode is ON')
                  }
                }

                controlThermostat({
                  setpointTemperature: {{input:SETPOINTTEMPERATURE}},
                  heatingvalve: {{input:HEATINGVALVE}},
                  temperaturesensor: {{input:TEMPERATURESENSOR}},
                  thermostat: {{input:THERMOSTAT}},
                  hysteresis: {{input:HYSTERESIS}},              
                  absencereduction: {{input:ABSENCEREDUCTION}}, 
                  greenincrease: {{input:GREENINCREASE}}, 
                  nightstart: {{input:NIGHTSTART}}, 
                  nightstop: {{input:NIGHTSTOP}}, 
                  nightreduction: {{input:NIGHTREDUCTION}},
                  windowcontact: {{input:WINDOWCONTACT}},
                  windowDelayMin: {{input:WINDOW_DELAY_MIN}},
                  setpointEffective: {{input:SETPOINTEFFECTIVE}},
                  loglevel: "{{field:LOGLEVEL}}",
                  absence: {{input:ABSENCE}},
                  booster: {{input:BOOSTER}},
                  smartgrid: {{input:SMARTGRID}}
                });
        toolbox:
          - component: PresetInput
            config:
              name: THERMOSTAT
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: HEATINGVALVE
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: SETPOINTTEMPERATURE
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: TEMPERATURESENSOR
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: NIGHTSTART
              fields:
                TEXT: 19:00
              shadow: true
              type: text
          - component: PresetInput
            config:
              name: NIGHTSTOP
              fields:
                TEXT: 08:15
              shadow: true
              type: text
          - component: PresetInput
            config:
              name: HYSTERESIS
              fields:
                NUM: "0.2"
              shadow: true
              type: math_number
          - component: PresetInput
            config:
              name: ABSENCEREDUCTION
              fields:
                NUM: "1"
              shadow: true
              type: math_number
          - component: PresetInput
            config:
              name: GREENINCREASE
              fields:
                NUM: "0.5"
              shadow: true
              type: math_number
          - component: PresetInput
            config:
              name: NIGHTREDUCTION
              fields:
                NUM: "0.5"
              shadow: true
              type: math_number
          - component: PresetInput
            config:
              name: ABSENCE
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: BOOSTER
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: SMARTGRID
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: SETPOINTEFFECTIVE
              shadow: true
              type: oh_item    
          - component: PresetInput
            config:
              name: WINDOWCONTACT
              shadow: true
              type: oh_item
          - component: PresetInput
            config:
              name: WINDOW_DELAY_MIN
              fields:
                NUM: "5"
              shadow: true
              type: math_number
    - component: BlockType
      config:
        args0:
          - name: METHOD
            options:
              - - disable
                - "false"
              - - enable
                - "true"
            type: field_dropdown
          - name: THING_UID
            type: input_value
        colour: 0
        helpUrl: ""
        inputsInline: false
        message0: set %1 for Thing %2
        nextStatement: ""
        previousStatement: ""
        tooltip: Enable or disable a Thing by UID
        type: Thing controller
      slots:
        code:
          - component: BlockCodeTemplate
            config:
              template: >
                var thingMgr =
                osgi.getService('org.openhab.core.thing.ThingManager');
                var ThingUID = 
                Java.type('org.openhab.core.thing.ThingUID');
                thingMgr.setEnabled(new ThingUID({{input:THING_UID}}),
                {{field:METHOD}});
        toolbox:
          - component: PresetInput
            config:
              name: THING_UID
              shadow: true
              type: oh_thing
  utilities:
    - component: UtilityJavaType
      config:
        javaClass: org.openhab.core.thing.ThingManager
        name: thingMgr
